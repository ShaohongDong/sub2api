# =============================================================================
# Sub2API Docker Compose - Infrastructure First
# =============================================================================
# This compose file supports two startup modes:
#
# 1) Infra only (PostgreSQL + Redis):
#    docker compose -f docker-compose.infra.local.yml --env-file .env.infra up -d postgres redis
#
# 2) Full stack (PostgreSQL + Redis + Sub2API):
#    docker compose -f docker-compose.infra.local.yml --env-file .env.infra up -d
#
# Data is stored in local directories for easy migration:
#   ./data, ./postgres_data, ./redis_data
# =============================================================================

services:
  sub2api:
    image: ${SUB2API_IMAGE:-weishaw/sub2api:latest}
    container_name: sub2api
    restart: unless-stopped
    ulimits:
      nofile:
        soft: 100000
        hard: 100000
    ports:
      - "${BIND_HOST:-0.0.0.0}:${SERVER_PORT:-8080}:8080"
    volumes:
      - ./data:/app/data
    environment:
      - AUTO_SETUP=true

      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8080
      - SERVER_MODE=${SERVER_MODE:-release}
      - RUN_MODE=${RUN_MODE:-standard}

      - DATABASE_HOST=postgres
      - DATABASE_PORT=${DATABASE_PORT:-5432}
      - DATABASE_USER=${POSTGRES_USER:-sub2api}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - DATABASE_DBNAME=${POSTGRES_DB:-sub2api}
      - DATABASE_SSLMODE=disable
      - DATABASE_MAX_OPEN_CONNS=${DATABASE_MAX_OPEN_CONNS:-256}
      - DATABASE_MAX_IDLE_CONNS=${DATABASE_MAX_IDLE_CONNS:-128}
      - DATABASE_CONN_MAX_LIFETIME_MINUTES=${DATABASE_CONN_MAX_LIFETIME_MINUTES:-30}
      - DATABASE_CONN_MAX_IDLE_TIME_MINUTES=${DATABASE_CONN_MAX_IDLE_TIME_MINUTES:-5}

      - REDIS_HOST=redis
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:?REDIS_PASSWORD is required}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_POOL_SIZE=${REDIS_POOL_SIZE:-4096}
      - REDIS_MIN_IDLE_CONNS=${REDIS_MIN_IDLE_CONNS:-256}
      - REDIS_ENABLE_TLS=false

      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@sub2api.local}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-}

      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
      - JWT_EXPIRE_HOUR=${JWT_EXPIRE_HOUR:-24}
      - TOTP_ENCRYPTION_KEY=${TOTP_ENCRYPTION_KEY:?TOTP_ENCRYPTION_KEY is required}

      - TZ=${TZ:-Asia/Shanghai}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - sub2api-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  postgres:
    image: ${POSTGRES_IMAGE:-postgres:18-alpine}
    container_name: sub2api-postgres
    restart: unless-stopped
    ulimits:
      nofile:
        soft: 100000
        hard: 100000
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    command: >
      postgres
      -c max_connections=${POSTGRES_MAX_CONNECTIONS:-1024}
      -c shared_buffers=${POSTGRES_SHARED_BUFFERS:-1GB}
      -c effective_cache_size=${POSTGRES_EFFECTIVE_CACHE_SIZE:-4GB}
      -c maintenance_work_mem=${POSTGRES_MAINTENANCE_WORK_MEM:-128MB}
    environment:
      - PGDATA=/var/lib/postgresql/data
      - POSTGRES_USER=${POSTGRES_USER:-sub2api}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - POSTGRES_DB=${POSTGRES_DB:-sub2api}
      - TZ=${TZ:-Asia/Shanghai}
    networks:
      - sub2api-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-sub2api} -d ${POSTGRES_DB:-sub2api}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s

  redis:
    image: ${REDIS_IMAGE:-redis:7-alpine}
    container_name: sub2api-redis
    restart: unless-stopped
    ulimits:
      nofile:
        soft: 100000
        hard: 100000
    volumes:
      - ./redis_data:/data
    command:
      - redis-server
      - --port
      - ${REDIS_PORT:-6379}
      - --save
      - "60"
      - "1"
      - --appendonly
      - "yes"
      - --appendfsync
      - everysec
      - --maxclients
      - ${REDIS_MAXCLIENTS:-50000}
      - --requirepass
      - ${REDIS_PASSWORD}
    environment:
      - TZ=${TZ:-Asia/Shanghai}
      - REDISCLI_AUTH=${REDIS_PASSWORD:?REDIS_PASSWORD is required}
    networks:
      - sub2api-network
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -h 127.0.0.1 -p ${REDIS_PORT:-6379} --no-auth-warning ping | grep -q PONG"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 5s

networks:
  sub2api-network:
    driver: bridge
